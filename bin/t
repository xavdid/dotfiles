#!/usr/bin/env zsh

# a general-purpose test runner
# hopefully one day not written in bash

set -e

if [ -f spec/test.rb ];then
    ruby spec/test.rb "$@"
elif [[ -f package.json && $(jq '.dependencies["zapier-platform-core"]' package.json) != 'null' ]];then
    # nice wrapper for npm test
    zapier test "$@"
elif [ -f package.json ];then
  if [ -f package-lock.json ];then
    npm run test "$@"
  else
    # could check if test key is defined, but since npm supplies it by default, it's fine
    yarn test "$@"
  fi
elif [ -f tests.py ];then # for cryptopals, not sure what the standard name is
    if [ -f poetry.lock ] ;then
        poetry run python tests.py
    else
        python tests.py
    fi
# syntax highlighting on this line is off - the "#qN" is a valid glob pattern
# see https://stackoverflow.com/a/41508466/1825390
# something is weird with this when run on its own
# elif [[ -n *_test.go(#qN) ]];then
#     go test "$@"
elif [[ -f mix.exs ]];then
    mix test "$@"
elif [[ -f Cargo.toml ]];then
    cargo test "$@"
elif [[ -f project.clj ]];then
    lein test "$@"
else
    echo "Can't guess testing method, do it yourself"
    exit 1
fi

